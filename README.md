NoDevent
=======
A system for notifying browser js clients about events happening on the server such as private messages, new discussion posts, or interesting resque jobs.  The goal is to reduce or elliminate the need for polling from the browser.

See a demo at http://nodevent.com

Quick* Start (Rails)
-----------
1) Install Node.js

2) Install and start NoDevent with npm:

    npm install nodevent
    npm start nodevent

3) Add the following to the gemspec

    gem 'nodevent'

nodevent expects a $redis global to exist and be a connect to your redis server.

4) Send some events

ActiveRecord Models:
```ruby
class SomeModel < ActiveRecord::Base
  include NoDevent
end

#Emit a model instance as a json object to that model
SomeModel.first.emit('the_event', SomeModel.first)

#Or just emit a message
NoDevent::Emitter.emit('the_room', 'the_event', 'the_message')

#You can also use an active record model as the room.
NoDevent::Emitter.emit(SomeModel.first, 'the_event', 'the_message')
```

3) Connect and listen for events in the browser
Load the socket.io layer:
```
<%= javascript_include_nodevent %>
```

Connect to a room and listen for events
```javascript
  var room = NoDevent.room('theroom');
  room.join();
  theroom.on("the_event",function(data){
    /* Do stuff with data */
  });
  
```

Thats it!

*Ok, so it's not that quick.


# Documentation

## Appliance / server

NoDevent is provided as an npm module/server.  Simply install the 'nodevent' module and you can 'npn start nodevent' to get started.  

### Configuration

NoDevent is configured via /etc/nodevent.json.  If you are running from source you can also provide the file to read as a command line parameter ('node server.js other_config.json').

An example config file.
```javascript
{
  "port" : 8080,
  "/nodevent" : { 
    "redis" : {"port" :6379 ,"host" : "localhost"}
  }
}
```
The above config us what is used by default if no config file is available.  It tells NoDevent to listen on port 8080, and have one namespace.  Each Namespace listens to a distinct redis instance for events.  Each namespace may also provide a secret for security.

You may provide an ssl : {key : <keyfile>, cert: <certfile>}` if you want to use ssl

### Security
It is possible to secure access to rooms with a secret key.  If a secret string has been provided for a room that room is secured and any client that wishes to join must provide a valid key.

A valid key is generated by:
```javascript
sha256(room + ts + secret)
```
where 'room' is the name of the room, ts is the experation time of the key, and secret is the secret configured.





## Web

### Connecting

```html
<script src='//localhost:8080/api/nodevent' type='text/javascript'></script
```

The above loads the required js, and initiates a socket.io connection to the '/nodevent' namespace.After this script tag, the NoDevent system is ready to go.

### JS Interface

#### NoDevent object

```javascript
window.NoDevent
```

You do not need to wait to use this object.  It will be there after the script tag has executed and it's ready to go.

##### Events
To keep up with what is happening with NoDevent you may listen for events directly on the window.NoDevent object:

```javascript
// Called when a connected to the server
NoDevent.on('connection', function(){});

// Called when disconnected from the server
NoDevent.on('disconnect', function(){});
```
You can also ask NoDevent directly if it is connected with the connected() method.

For more events, see https://github.com/LearnBoost/socket.io-client/

#####  Rooms

To get events you must first join a room.

```javascript
var room = NoDevent.room('the_room')
```

The room object returned is where you manage all interactions with a room

###### Methods and Properties

Setting the key for a room (see security section above)
```javascript
room.setKey(key)
```

Joining a room:
```javascript
room.join(function(err){});
```
Initiates a request to join a room.  If a callback fn is provided it will be called a single time, with an err if the join failed.

Leaving a room
```javascript
room.leave(function(err){});
```
Initiates a request to leave a room.  If a callback fn is provided it will be called a single time, with an err if leaving the room failed.

If all you have is the room object you can get the room's name
```javascript
room.id;
```


